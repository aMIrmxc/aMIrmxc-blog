---
interface Props {
	post_id: string;
}
const { post_id } = Astro.props;
---

<form class="mb-16 mt-8 text-xl font-bold">
	<input type="hidden" name="post_id" value={post_id} />
  <div class="mb-4">
    <!-- <label for="comment" class="block  text-gray-700 text-sm">Comment</label> -->
    <textarea
      
      id="comment"
      name="comment"
      rows="4"
      class=" my-4 p-4 block text-2xl font-bold w-full h-64 rounded-md border-gray-300 shadow-sm focus:border-accent focus:ring-accent "
      required></textarea>
  </div>
  <button
    type="submit"
    class="my-4 inline-flex items-center rounded-md border border-transparent bg-accent px-4 py-2 text-white shadow-sm hover:bg-accent/80 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
  >
    Submit
  </button>
</form>

<style>
  textarea {
    border-color: var(--color-accent);
    background-color: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    box-shadow: 0 0 0 1px var(--color-accent);

  }
  textarea:focus {
    box-shadow: 0 0 0 2px var(--color-accent);
    outline: none;
  }
</style>

<script >
  import { supabase } from "../../utils/supabase";

  document.querySelector("form")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const comment = formData.get("comment") as string;
    const postId = formData.get("post_id") as string;

    if (comment) {
      try {
        // Since we don't have user auth, we'll use a placeholder.
        // In a real app, you'd get the user from supabase.auth.getUser()
        const placeholder_user_id = import.meta.env.PLACEHOLDER_USER_ID;

        const { data, error } = await supabase
          .from("comments")
          .insert({
            post_id: postId,
            comment_text: comment,
            user_id: placeholder_user_id,
          })
          .select()
          .single();

        if (error) {
          throw error;
        }

        if (data) {
          const event = new CustomEvent("new-comment", {
            bubbles: true,
            detail: data,
          });
          form.dispatchEvent(event);
          form.reset();
        }
      } catch (error) {
        console.error("Error submitting comment:", error);
        alert("Error submitting comment. Check the console for details.");
      }
    }
  });
</script>