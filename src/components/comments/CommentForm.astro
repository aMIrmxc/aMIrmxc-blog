---
import { getMessages } from "../../utils/i18n";
interface Props {
  post_id: string;
  dir?: "ltr" | "rtl";
}
const { post_id, dir } = Astro.props;

const messages = getMessages(dir ?? 'ltr').comments.form;
---

<form
  class="mb-16 mt-8 text-xl font-bold"
  dir={dir}
  data-submitting-text={messages.submitting}
  data-success-text={messages.success}
  data-error-text={messages.error}
>
  <input type="hidden" name="post_id" value={post_id} />
  <div class="mb-4">
    <textarea
      id="comment"
      name="comment"
      rows="4"
      class=" my-4 p-4 block text-2xl font-bold w-full h-64 rounded-md border-gray-300 shadow-sm focus:border-accent focus:ring-accent "
      required
      placeholder={messages.comment}
    ></textarea>
  </div>
  <button
    type="submit"
    class="my-4 inline-flex items-center rounded-md border border-transparent bg-accent px-4 py-2 text-white shadow-sm hover:bg-accent/80 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
  >
    {messages.submit}
  </button>
</form>

<style>
  textarea {
    border-color: var(--color-accent);
    background-color: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    box-shadow: 0 0 0 1px var(--color-accent);

  }
  textarea:focus {
    box-shadow: 0 0 0 2px var(--color-accent);
    outline: none;
  }
</style>

<script>
  import { supabase } from "../../utils/supabase";

  document.querySelector("form")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const comment = formData.get("comment") as string;
    const postId = formData.get("post_id") as string;
    const submitButton = form.querySelector("button[type='submit']") as HTMLButtonElement;

    const originalButtonText = submitButton.textContent;
    submitButton.textContent = form.dataset.submittingText || 'Submitting...';
    submitButton.disabled = true;


    if (comment) {
      try {
        const placeholder_user_id = import.meta.env.PUBLIC_PLACEHOLDER_USER_ID;

        const { data, error } = await supabase
          .from("comments")
          .insert({
            post_id: postId,
            comment_text: comment,
            user_id: placeholder_user_id,
          })
          .select()
          .single();

        if (error) {
          throw error;
        }

        if (data) {
          const event = new CustomEvent("new-comment", {
            bubbles: true,
            detail: data,
          });
          form.dispatchEvent(event);
          form.reset();
          const successEvent = new CustomEvent("show-notification", {
            bubbles: true,
            composed: true,
            detail: { message: form.dataset.successText || 'Comment submitted!' },
          });
          document.dispatchEvent(successEvent);
        }
      } catch (error) {
        console.error("Error submitting comment:", error);
        const errorEvent = new CustomEvent("show-notification", {
            bubbles: true,
            composed: true,
            detail: { message: form.dataset.errorText || 'Error submitting comment.', isError: true },
          });
        document.dispatchEvent(errorEvent);
      } finally {
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
      }
    }
  });
</script>
