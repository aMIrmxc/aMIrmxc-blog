---
import CommentForm from "./CommentForm.astro";
import { supabase } from "../../utils/supabase";
import Comment from "./Comment.astro";

interface Props {
  dir: "ltr" | "rtl";
  post_id: string;
}

const { dir, post_id } = Astro.props;

const { data: comments, error } = await supabase
  .from("comments")
  .select(
    `
    comment_text,
    created_at,
    profiles (
      first_name,
      last_name
    )`
  )
  .eq("post_id", post_id)
  .order("created_at", { ascending: false });

---
<section
  dir={dir}
  id="comments"
  class="max-w-8xl mt-32 w-full text-xl font-bold"
>
  <p class="mb-1 text-xl font-bold">
    {dir === "rtl" ? "نظر تو چیه؟" : "What is your opinion? "}
  </p>

  <CommentForm post_id={post_id} />
  <div id="comments-list" class="mb-32 space-y-4">
    {
      error && (
        <div class="text-red-500">
          Error fetching comments. Visit console for more info.
        </div>
      )
    }
    {
      !comments && !error && <div>Loading comments...</div>
    }
    {
      !error && comments && comments.length === 0 && (
        <div class="text-gray-500">No comments yet. Be the first to comment!</div>
      )
    }
    {
      !error &&
        comments &&
        comments.map((comment) => {
          const profile = comment.profiles as unknown as {
            first_name: string;
            last_name: string;
          };
          const author =
            `${profile?.first_name ?? ""} ${profile?.last_name ?? ""}`.trim() ||
            "Anonymous";
          return (
            <Comment
              author={author}
              date={new Date(comment.created_at)}
              content={comment.comment_text}
            />
          );
        })
    }
  </div>
</section>

<script>
  document.addEventListener("new-comment", (e) => {
    const comment = (e as CustomEvent).detail;
    const commentsList = document.getElementById("comments-list");
    if (commentsList) {
      // Remove the "No comments yet" message if it exists
      const noCommentsMessage = commentsList.querySelector(".text-gray-500");
      if (noCommentsMessage) {
        noCommentsMessage.remove();
      }
      const profile = comment.profiles as {
        first_name: string;
        last_name: string;
      };
      const author =
        `${profile?.first_name ?? ""} ${profile?.last_name ?? ""}`.trim() ||
        "Anonymous";
      const newCommentElement = document.createElement("div");
      newCommentElement.innerHTML = `<div class="flex items-start space-x-4 my-16 text-xl font-bold">
 <div class="flex-shrink-0">
 <img
 class="w-10 h-10 rounded-full"
 src="/user.png"
 alt=${author}
 />
 </div>
 <div class="flex-1 min-w-0">
 <div class="flex items-center justify-between">
 <span class="font-bold">${author}</span>
 <span class="text-l text-gray-500">${new Date(
        comment.created_at
      ).toDateString()}</span>
 </div>
 <p class="my-8 comment-content">${comment.comment_text}</p>
 </div>
 </div>`;
      commentsList.prepend(newCommentElement);
    }
  });
</script>