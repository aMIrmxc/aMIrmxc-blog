---
import CommentForm from "./CommentForm.astro";

interface Props {
  dir: "ltr" | "rtl";
  post_id: string;
}

const { dir, post_id } = Astro.props;
---

<section
  dir={dir}
  id="comments"
  class="max-w-8xl mt-32 w-full text-xl font-bold"
>
  <p class="mb-1 text-xl font-bold">
    {dir === "rtl" ? "نظر تو چیه؟" : "What is your opinion? "}
  </p>

  <CommentForm post_id={post_id} />
  <div id="comments-list" class="mb-32 space-y-4"></div>
</section>

<script>
  import { supabase } from "../../utils/supabase";

  const createCommentElement = (comment: {
    comment_text: string;
    created_at: string;
    profiles: { first_name: string; last_name: string }[] | null;
  }) => {
    const profile = comment.profiles?.[0];
    const author =
      `${profile?.first_name ?? ""} ${profile?.last_name ?? ""}`.trim() ||
      "Anonymous";
    const newComment = document.createElement("div");
    newComment.classList.add(
      "flex",
      "items-start",
      "space-x-4",
      "my-16",
      "text-xl",
      "font-bold"
    );
    newComment.innerHTML = `
      <div class="flex-shrink-0">
        <img class="w-10 h-10 rounded-full" src="/user.png" />
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center justify-between">
          <span class="font-bold">${author}</span>
          <span class="text-l text-gray-500">${new Date(
            comment.created_at
          ).toDateString()}</span>
        </div>
        <p class="my-8 comment-content">${comment.comment_text}</p>
      </div>
    `;
    return newComment;
  };

  async function fetchComments() {
    const commentsList = document.getElementById("comments-list");
    if (!commentsList) return;
    
    // This is a bit of a hack to get the post_id into the client script.
    // A better way would be to pass it as a prop if this was a framework component.
    const postId = (document.querySelector('input[name="post_id"]') as HTMLInputElement)?.value;
    if(!postId) return;



  const { data: comments, error } = await supabase
  .from("comments")
  .select(`
    comment_text,
    created_at,
    profiles (
      first_name,
      last_name
    )`
  )
  .eq("post_id", postId).order("created_at", { ascending: false });
// The result will look like:
// [
//   {
//     comment_text: "Great post!",
//     created_at: "...",
//     profiles: {
//       first_name: "John",
//       last_name: "Doe"
//     }
//   }
// ]


    if (error) {
      console.error("Error fetching comments:", error);
      return;
    }

    if (comments) {
      commentsList.innerHTML = ""; // Clear existing comments
      for (const comment of comments) {
        const commentElement = createCommentElement(comment);
        commentsList.appendChild(commentElement);
      }
    }
  }

  document.addEventListener("DOMContentLoaded", fetchComments);

  document.addEventListener("new-comment", (e) => {
    const comment = (e as CustomEvent).detail;
    const commentsList = document.getElementById("comments-list");
    if (commentsList) {
      const newCommentElement = createCommentElement(comment);
      commentsList.prepend(newCommentElement);
    }
  });
</script>