---
import CommentForm from "./CommentForm.astro";
import { supabase } from "../../utils/supabase";
import Comment from "./Comment.astro";

interface Props {
  dir: "ltr" | "rtl";
  post_id: string;
}

const { dir, post_id } = Astro.props;

const { data: comments, error } = await supabase
  .from("comments")
  .select(
    `
    comment_text,
    created_at,
    profiles (
      first_name,
      last_name
    )`
  )
  .eq("post_id", post_id)
  .order("created_at", { ascending: false });

if (error) {
  console.error("Error fetching comments:", error);
}
---

<section
  dir={dir}
  id="comments"
  class="max-w-8xl mt-32 w-full text-xl font-bold"
>
  <p class="mb-1 text-xl font-bold">
    {dir === "rtl" ? "نظر تو چیه؟" : "What is your opinion? "}
  </p>

  <CommentForm post_id={post_id} />
  <div id="comments-list" class="mb-32 space-y-4">
    {
      comments &&
        comments.map((comment) => {
          const profile = comment.profiles?.[0];
          const author =
            `${profile?.first_name ?? ""} ${profile?.last_name ?? ""}`.trim() ||
            "Anonymous";
          return (
            <Comment
              author={author}
              date={new Date(comment.created_at)}
              content={comment.comment_text}
            />
          );
        })
    }
  </div>
</section>

<script>
  document.addEventListener("new-comment", (e) => {
    const comment = (e as CustomEvent).detail;
    const commentsList = document.getElementById("comments-list");
    if (commentsList) {
      const profile = comment.profiles?.[0];
      const author =
        `${profile?.first_name ?? ""} ${profile?.last_name ?? ""}`.trim() ||
        "Anonymous";

      // This is not a good practice, but for now it's fine
      const newCommentElement = document.createElement("div");
      newCommentElement.innerHTML = `<div class="flex items-start space-x-4 my-16 text-xl font-bold">
   <div class="flex-shrink-0">
     <img
       class="w-10 h-10 rounded-full"
       src="https://i.pravatar.cc/150?u=${author}"
       alt=${author}
     />
   </div>
   <div class="flex-1 min-w-0">
     <div class="flex items-center justify-between">
       <span class="font-bold">${author}</span>
       <span class="text-l text-gray-500">${new Date(
         comment.created_at
       ).toDateString()}</span>
     </div>
     <p class="my-8 comment-content">${comment.comment_text}</p>
   </div>
 </div>`;

      commentsList.prepend(newCommentElement);
    }
  });
</script>